<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to testdat • testdat</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to testdat">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">testdat</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/testdat.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Introduction to testdat</h1>
            
      
      
      <div class="hidden name"><code>testdat.Rmd</code></div>

    </div>

    
    
<p>testdat is a package designed to ease data validation, particularly for complex data processing, inspired by software unit testing. testdat extends the strong and flexible unit testing framework already provided by testthat with a family of functions and reporting tools focused on checking of data frames.</p>
<p>Features include:</p>
<ul>
<li><p>A fully fledged test framework so you can spend more time specifying tests and less time running them</p></li>
<li><p>A set of common methods for simply specifying data validation rules</p></li>
<li><p>Repeatability of data tests (avoid unintentionally breaking your dataset!)</p></li>
<li><p>Data-focused reporting of test results</p></li>
</ul>
<div id="getting-started" class="section level1">
<h1 class="hasAnchor">
<a href="#getting-started" class="anchor"></a>Getting started</h1>
<p>As an extension of testthat, testdat uses the same basic testing framework. Before using testdat (and reading this documentation), make sure you’re familiar with the introduction to testthat in <a href="http://r-pkgs.had.co.nz/tests.html">R packages</a>.</p>
<p>The main addition provided by testdat is a set of expectations designed for testing data frames and a context-esque mechanism to set a current testing data frame.</p>
</div>
<div id="data-expectations" class="section level1">
<h1 class="hasAnchor">
<a href="#data-expectations" class="anchor"></a>Data expectations</h1>
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>In general, our approach to data testing is variable-centric - the majority of expectations perform a check on one or more variables in a given dataset.</p>
<p>The standard form of a data expectation is:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1">expect_<span class="op">*</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">var</a></span>(s), ..., <span class="dt">flt =</span> <span class="ot">TRUE</span>, <span class="dt">data =</span> <span class="kw"><a href="../reference/global-data.html">get_testdata</a></span>())</a></code></pre></div>
<p>testdat uses dplyr at its core, and thus supports tidy evaluation.</p>
<div id="variables" class="section level3">
<h3 class="hasAnchor">
<a href="#variables" class="anchor"></a>Variables</h3>
<p>Most operations act on one or more variables There are two variants of the variable argument:</p>
<ul>
<li>
<code>var</code> requires an unquoted variable name.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">test_that</span>(<span class="st">"hour values are valid"</span>, {</a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="kw"><a href="../reference/value-expectations.html">expect_range</a></span>(hour, <span class="dv">0</span>, <span class="dv">23</span>, <span class="dt">data =</span> storms)</a>
<a class="sourceLine" id="cb2-3" title="3">})</a></code></pre></div>
<ul>
<li>
<code>vars</code> requires a variable set specified by dplyr’s <code><a href="https://dplyr.tidyverse.org/reference/vars.html">vars()</a></code> function.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">test_that</span>(<span class="st">"multi-variable identifier is unique"</span>, {</a>
<a class="sourceLine" id="cb3-2" title="2">  <span class="kw"><a href="../reference/value-expectations.html">expect_unique</a></span>(<span class="kw"><a href="https://dplyr.tidyverse.org/reference/vars.html">vars</a></span>(name, year, month, day, hour), <span class="dt">data =</span> storms)</a>
<a class="sourceLine" id="cb3-3" title="3">})</a>
<a class="sourceLine" id="cb3-4" title="4"><span class="co">#&gt; Error: Test failed: 'multi-variable identifier is unique'</span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="co">#&gt; * `storms` has 32 duplicate records on variable `name, year, month, day, hour`.</span></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="co">#&gt; Filter: None</span></a></code></pre></div>
</div>
<div id="filter" class="section level3">
<h3 class="hasAnchor">
<a href="#filter" class="anchor"></a>Filter</h3>
<p>The <code>flt</code> argument takes a logical predicate defined in terms of the variables in <code>data</code>. Only rows where the condition evaluates to <code>TRUE</code> are included in the test.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">test_that</span>(<span class="st">"iris range checks"</span>, {</a>
<a class="sourceLine" id="cb4-2" title="2">  <span class="kw"><a href="../reference/value-expectations.html">expect_range</a></span>(Petal.Width, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">data =</span> iris)</a>
<a class="sourceLine" id="cb4-3" title="3">})</a>
<a class="sourceLine" id="cb4-4" title="4"><span class="co">#&gt; Error: Test failed: 'iris range checks'</span></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="co">#&gt; * `iris` has 93 records failing range check on variable `Petal.Width`.</span></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="co">#&gt; Filter: None</span></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="co">#&gt; Arguments: `min = 0, max = 1`</span></a>
<a class="sourceLine" id="cb4-8" title="8"></a>
<a class="sourceLine" id="cb4-9" title="9"><span class="kw">test_that</span>(<span class="st">"iris range checks filtered"</span>, {</a>
<a class="sourceLine" id="cb4-10" title="10">  <span class="co"># Test passes for setosa rows</span></a>
<a class="sourceLine" id="cb4-11" title="11">  <span class="kw"><a href="../reference/value-expectations.html">expect_range</a></span>(Petal.Width, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">flt =</span> Species <span class="op">==</span><span class="st"> "setosa"</span>, <span class="dt">data =</span> iris)</a>
<a class="sourceLine" id="cb4-12" title="12">  <span class="co"># Failures will provide the filter</span></a>
<a class="sourceLine" id="cb4-13" title="13">  <span class="kw"><a href="../reference/value-expectations.html">expect_range</a></span>(Petal.Width, <span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dt">flt =</span> Species <span class="op">==</span><span class="st"> "setosa"</span>, <span class="dt">data =</span> iris)</a>
<a class="sourceLine" id="cb4-14" title="14">})</a>
<a class="sourceLine" id="cb4-15" title="15"><span class="co">#&gt; Error: Test failed: 'iris range checks filtered'</span></a>
<a class="sourceLine" id="cb4-16" title="16"><span class="co">#&gt; * `iris` has 1 records failing range check on variable `Petal.Width`.</span></a>
<a class="sourceLine" id="cb4-17" title="17"><span class="co">#&gt; Filter: `Species == "setosa"`</span></a>
<a class="sourceLine" id="cb4-18" title="18"><span class="co">#&gt; Arguments: `min = 0, max = 0.5`</span></a></code></pre></div>
</div>
<div id="data" class="section level3">
<h3 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h3>
<p>The <code>data</code> argument takes a data frame to test. To avoid redundant code the data argument defaults to a global test data set retrieved using <code><a href="../reference/global-data.html">get_testdata()</a></code>. This can be used in two ways:</p>
<ul>
<li>Setting the global test data using <code><a href="../reference/global-data.html">set_testdata()</a></code>.</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw"><a href="../reference/global-data.html">set_testdata</a></span>(iris)</a>
<a class="sourceLine" id="cb5-2" title="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/identical">identical</a></span>(<span class="kw"><a href="../reference/global-data.html">get_testdata</a></span>(), iris)</a>
<a class="sourceLine" id="cb5-3" title="3"><span class="co">#&gt; [1] TRUE</span></a>
<a class="sourceLine" id="cb5-4" title="4"></a>
<a class="sourceLine" id="cb5-5" title="5"><span class="kw">test_that</span>(<span class="st">"Versicolor has sepal length greater than 5 - will fail"</span>, {</a>
<a class="sourceLine" id="cb5-6" title="6">  <span class="kw"><a href="../reference/conditional-expectations.html">expect_cond</a></span>(Species <span class="op">%in%</span><span class="st"> "versicolor"</span>, Sepal.Length <span class="op">&gt;=</span><span class="st"> </span><span class="dv">5</span>)</a>
<a class="sourceLine" id="cb5-7" title="7">})</a>
<a class="sourceLine" id="cb5-8" title="8"><span class="co">#&gt; Error: Test failed: 'Versicolor has sepal length greater than 5 - will fail'</span></a>
<a class="sourceLine" id="cb5-9" title="9"><span class="co">#&gt; * get_testdata() failed consistency check. 1 cases have `Species %in% "versicolor"` but not `Sepal.Length &gt;= 5`.</span></a></code></pre></div>
<ul>
<li>Using the <code><a href="../reference/global-data.html">with_testdata()</a></code> wrapper to temporarily set the global test data for a block of code.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="kw"><a href="../reference/global-data.html">set_testdata</a></span>(mtcars)</a>
<a class="sourceLine" id="cb6-2" title="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/identical">identical</a></span>(<span class="kw"><a href="../reference/global-data.html">get_testdata</a></span>(), mtcars)</a>
<a class="sourceLine" id="cb6-3" title="3"><span class="co">#&gt; [1] TRUE</span></a>
<a class="sourceLine" id="cb6-4" title="4"></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="kw"><a href="../reference/global-data.html">with_testdata</a></span>(iris, {</a>
<a class="sourceLine" id="cb6-6" title="6">  <span class="kw">test_that</span>(<span class="st">"Versicolor has sepal length greater than 5 - will fail"</span>, {</a>
<a class="sourceLine" id="cb6-7" title="7">    <span class="kw"><a href="../reference/conditional-expectations.html">expect_cond</a></span>(Species <span class="op">%in%</span><span class="st"> "versicolor"</span>, Sepal.Length <span class="op">&gt;=</span><span class="st"> </span><span class="dv">5</span>)</a>
<a class="sourceLine" id="cb6-8" title="8">  })</a>
<a class="sourceLine" id="cb6-9" title="9">})</a>
<a class="sourceLine" id="cb6-10" title="10"><span class="co">#&gt; Error: Test failed: 'Versicolor has sepal length greater than 5 - will fail'</span></a>
<a class="sourceLine" id="cb6-11" title="11"><span class="co">#&gt; * get_testdata() failed consistency check. 1 cases have `Species %in% "versicolor"` but not `Sepal.Length &gt;= 5`.</span></a>
<a class="sourceLine" id="cb6-12" title="12"></a>
<a class="sourceLine" id="cb6-13" title="13"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/identical">identical</a></span>(<span class="kw"><a href="../reference/global-data.html">get_testdata</a></span>(), mtcars)</a>
<a class="sourceLine" id="cb6-14" title="14"><span class="co">#&gt; [1] TRUE</span></a></code></pre></div>
<p>Both approaches are equivalent to:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">test_that</span>(<span class="st">"Versicolor has sepal length greater than 5 - will fail"</span>, {</a>
<a class="sourceLine" id="cb7-2" title="2">  <span class="kw"><a href="../reference/conditional-expectations.html">expect_cond</a></span>(Species <span class="op">%in%</span><span class="st"> "versicolor"</span>, Sepal.Length <span class="op">&gt;=</span><span class="st"> </span><span class="dv">5</span>, <span class="dt">data =</span> iris)</a>
<a class="sourceLine" id="cb7-3" title="3">})</a>
<a class="sourceLine" id="cb7-4" title="4"><span class="co">#&gt; Error: Test failed: 'Versicolor has sepal length greater than 5 - will fail'</span></a>
<a class="sourceLine" id="cb7-5" title="5"><span class="co">#&gt; * `iris` failed consistency check. 1 cases have `Species %in% "versicolor"` but not `Sepal.Length &gt;= 5`.</span></a></code></pre></div>
</div>
<div id="section" class="section level3">
<h3 class="hasAnchor">
<a href="#section" class="anchor"></a><code>...</code>
</h3>
<p>Additional arguments are specific to the expectation. See the man page for the function for details.</p>
</div>
</div>
<div id="categories" class="section level2">
<h2 class="hasAnchor">
<a href="#categories" class="anchor"></a>Categories</h2>
<p>Data expectations fall into a few main classes.</p>
<dl>
<dt>Value</dt>
<dd>
<p><code><a href="../reference/value-expectations.html">?`value-expectations`</a></code></p>
<p>Value expectations test variable values for valid data. Tests include explicit value checks, uniqueness and others.</p>
</dd>
<dt>Conditional</dt>
<dd>
<p><code><a href="../reference/conditional-expectations.html">?`conditional-expectations`</a></code></p>
<p>Conditional expectations check for the co-existence of multiple conditions.</p>
</dd>
<dt>Dataset comparison</dt>
<dd>
<p><code><a href="../reference/datacomp-expectations.html">?`datacomp-expectations`</a></code></p>
<p>Dataset comparison expectations test for consistency between datasets, for example ensuring similar frequencies between similar variables in different datasets.</p>
</dd>
<dt>Generic</dt>
<dd>
<p><code><a href="../reference/generic-expectations.html">?`generic-expectations`</a></code></p>
<p>Generic expectations allow for testing of a dataset using an arbitrary function. The function provided should take a single vector as its first argument and return a logical vector showing whether each element has passed or failed. Additional arguments to the checking function can be passed as a list using the <code>args</code> argument.</p>
<p>testdat includes a set of useful checking functions. See <code><a href="../reference/chk-generic.html">?`chk-generic`</a></code> for details. Several of the checking functions have a corresponding expectation. These are listed in <code><a href="../reference/chk-expect.html">?`chk-expect`</a></code>.</p>
</dd>
</dl>
</div>
</div>
<div id="using-tests" class="section level1">
<h1 class="hasAnchor">
<a href="#using-tests" class="anchor"></a>Using tests</h1>
<div id="testing-inside-a-script" class="section level2">
<h2 class="hasAnchor">
<a href="#testing-inside-a-script" class="anchor"></a>Testing inside a script</h2>
<p>The easiest way to use data testing is directly inside an R script. Expecations and test blocks throw an error if they fail, so it is very clear to the user that something needs to be checked, and the script will fail when sourced.</p>
<p>The example below shows how to adapt a script from exploratory “print and check” to a testing approach, using a simple sample processing exercise.</p>
<div id="print-and-check" class="section level3">
<h3 class="hasAnchor">
<a href="#print-and-check" class="anchor"></a>Print and check</h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)</a>
<a class="sourceLine" id="cb8-2" title="2"></a>
<a class="sourceLine" id="cb8-3" title="3">x &lt;-<span class="st"> </span><span class="kw">tribble</span>(<span class="op">~</span>id, <span class="op">~</span>pcode, <span class="op">~</span>state, <span class="op">~</span>nsw_only,</a>
<a class="sourceLine" id="cb8-4" title="4">             <span class="dv">1</span>,   <span class="dv">2000</span>,   <span class="st">"NSW"</span>,  <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb8-5" title="5">             <span class="dv">2</span>,   <span class="dv">3123</span>,   <span class="st">"VIC"</span>,  <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb8-6" title="6">             <span class="dv">3</span>,   <span class="dv">2123</span>,   <span class="st">"NSW"</span>,  <span class="dv">3</span>,</a>
<a class="sourceLine" id="cb8-7" title="7">             <span class="dv">4</span>,   <span class="dv">12345</span>,  <span class="st">"VIC"</span>,  <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb8-8" title="8"></a>
<a class="sourceLine" id="cb8-9" title="9"><span class="co"># check id is unique</span></a>
<a class="sourceLine" id="cb8-10" title="10">x <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/duplicated">duplicated</a></span>(id))</a>
<a class="sourceLine" id="cb8-11" title="11"><span class="co">#&gt; # A tibble: 0 x 4</span></a>
<a class="sourceLine" id="cb8-12" title="12"><span class="co">#&gt; # ... with 4 variables: id &lt;dbl&gt;, pcode &lt;dbl&gt;, state &lt;chr&gt;, nsw_only &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb8-13" title="13"></a>
<a class="sourceLine" id="cb8-14" title="14"><span class="co"># check values</span></a>
<a class="sourceLine" id="cb8-15" title="15">x <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(<span class="op">!</span>pcode <span class="op">%in%</span><span class="st"> </span><span class="dv">2000</span><span class="op">:</span><span class="dv">3999</span>)</a>
<a class="sourceLine" id="cb8-16" title="16"><span class="co">#&gt; # A tibble: 1 x 4</span></a>
<a class="sourceLine" id="cb8-17" title="17"><span class="co">#&gt;      id pcode state nsw_only</span></a>
<a class="sourceLine" id="cb8-18" title="18"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb8-19" title="19"><span class="co">#&gt; 1     4 12345 VIC          3</span></a>
<a class="sourceLine" id="cb8-20" title="20">x <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>(state)</a>
<a class="sourceLine" id="cb8-21" title="21"><span class="co">#&gt; # A tibble: 2 x 2</span></a>
<a class="sourceLine" id="cb8-22" title="22"><span class="co">#&gt;   state     n</span></a>
<a class="sourceLine" id="cb8-23" title="23"><span class="co">#&gt;   &lt;chr&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb8-24" title="24"><span class="co">#&gt; 1 NSW       2</span></a>
<a class="sourceLine" id="cb8-25" title="25"><span class="co">#&gt; 2 VIC       2</span></a>
<a class="sourceLine" id="cb8-26" title="26">x <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>(nsw_only)</a>
<a class="sourceLine" id="cb8-27" title="27"><span class="co">#&gt; # A tibble: 3 x 2</span></a>
<a class="sourceLine" id="cb8-28" title="28"><span class="co">#&gt;   nsw_only     n</span></a>
<a class="sourceLine" id="cb8-29" title="29"><span class="co">#&gt;      &lt;dbl&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb8-30" title="30"><span class="co">#&gt; 1        1     1</span></a>
<a class="sourceLine" id="cb8-31" title="31"><span class="co">#&gt; 2        3     2</span></a>
<a class="sourceLine" id="cb8-32" title="32"><span class="co">#&gt; 3       NA     1</span></a>
<a class="sourceLine" id="cb8-33" title="33"></a>
<a class="sourceLine" id="cb8-34" title="34"><span class="co"># check base for nsw_only variable</span></a>
<a class="sourceLine" id="cb8-35" title="35">x <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(state <span class="op">!=</span><span class="st"> "NSW"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>(nsw_only)</a>
<a class="sourceLine" id="cb8-36" title="36"><span class="co">#&gt; # A tibble: 2 x 2</span></a>
<a class="sourceLine" id="cb8-37" title="37"><span class="co">#&gt;   nsw_only     n</span></a>
<a class="sourceLine" id="cb8-38" title="38"><span class="co">#&gt;      &lt;dbl&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb8-39" title="39"><span class="co">#&gt; 1        3     1</span></a>
<a class="sourceLine" id="cb8-40" title="40"><span class="co">#&gt; 2       NA     1</span></a>
<a class="sourceLine" id="cb8-41" title="41"></a>
<a class="sourceLine" id="cb8-42" title="42">x &lt;-<span class="st"> </span>x <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">market =</span> <span class="kw">case_when</span>(pcode <span class="op">%in%</span><span class="st"> </span><span class="dv">2000</span><span class="op">:</span><span class="dv">2999</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb8-43" title="43">                                     pcode <span class="op">%in%</span><span class="st"> </span><span class="dv">3000</span><span class="op">:</span><span class="dv">3999</span> <span class="op">~</span><span class="st"> </span><span class="dv">2</span>))</a>
<a class="sourceLine" id="cb8-44" title="44"></a>
<a class="sourceLine" id="cb8-45" title="45">x <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>(market)</a>
<a class="sourceLine" id="cb8-46" title="46"><span class="co">#&gt; # A tibble: 3 x 2</span></a>
<a class="sourceLine" id="cb8-47" title="47"><span class="co">#&gt;   market     n</span></a>
<a class="sourceLine" id="cb8-48" title="48"><span class="co">#&gt;    &lt;dbl&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb8-49" title="49"><span class="co">#&gt; 1      1     2</span></a>
<a class="sourceLine" id="cb8-50" title="50"><span class="co">#&gt; 2      2     1</span></a>
<a class="sourceLine" id="cb8-51" title="51"><span class="co">#&gt; 3     NA     1</span></a></code></pre></div>
</div>
<div id="testdat" class="section level3">
<h3 class="hasAnchor">
<a href="#testdat" class="anchor"></a>testdat</h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(testdat)</a>
<a class="sourceLine" id="cb9-2" title="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)</a>
<a class="sourceLine" id="cb9-3" title="3"></a>
<a class="sourceLine" id="cb9-4" title="4">x &lt;-<span class="st"> </span><span class="kw">tribble</span>(<span class="op">~</span>id, <span class="op">~</span>pcode, <span class="op">~</span>state, <span class="op">~</span>nsw_only,</a>
<a class="sourceLine" id="cb9-5" title="5">             <span class="dv">1</span>,   <span class="dv">2000</span>,   <span class="st">"NSW"</span>,  <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb9-6" title="6">             <span class="dv">2</span>,   <span class="dv">3123</span>,   <span class="st">"VIC"</span>,  <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb9-7" title="7">             <span class="dv">3</span>,   <span class="dv">2123</span>,   <span class="st">"NSW"</span>,  <span class="dv">3</span>,</a>
<a class="sourceLine" id="cb9-8" title="8">             <span class="dv">4</span>,   <span class="dv">12345</span>,  <span class="st">"VIC"</span>,  <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb9-9" title="9"></a>
<a class="sourceLine" id="cb9-10" title="10"><span class="kw"><a href="../reference/global-data.html">with_testdata</a></span>(x, {</a>
<a class="sourceLine" id="cb9-11" title="11">  <span class="kw">test_that</span>(<span class="st">"id is unique"</span>, {</a>
<a class="sourceLine" id="cb9-12" title="12">    <span class="kw"><a href="../reference/value-expectations.html">expect_unique</a></span>(<span class="kw"><a href="https://dplyr.tidyverse.org/reference/vars.html">vars</a></span>(id))</a>
<a class="sourceLine" id="cb9-13" title="13">  })</a>
<a class="sourceLine" id="cb9-14" title="14">  </a>
<a class="sourceLine" id="cb9-15" title="15">  <span class="kw">test_that</span>(<span class="st">"variable values are correct"</span>, {</a>
<a class="sourceLine" id="cb9-16" title="16">    <span class="kw"><a href="../reference/value-expectations.html">expect_values</a></span>(pcode, <span class="dv">2000</span><span class="op">:</span><span class="dv">2999</span>, <span class="dv">3000</span><span class="op">:</span><span class="dv">3999</span>)</a>
<a class="sourceLine" id="cb9-17" title="17">    <span class="kw"><a href="../reference/value-expectations.html">expect_values</a></span>(state, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"NSW"</span>, <span class="st">"VIC"</span>))</a>
<a class="sourceLine" id="cb9-18" title="18">    <span class="kw"><a href="../reference/value-expectations.html">expect_values</a></span>(nsw_only, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>) <span class="co"># by default expect_values allows NAs</span></a>
<a class="sourceLine" id="cb9-19" title="19">  })</a>
<a class="sourceLine" id="cb9-20" title="20">  </a>
<a class="sourceLine" id="cb9-21" title="21">  <span class="kw">test_that</span>(<span class="st">"filters applied correctly"</span>, {</a>
<a class="sourceLine" id="cb9-22" title="22">    <span class="kw"><a href="../reference/conditional-expectations.html">expect_base</a></span>(nsw_only, state <span class="op">==</span><span class="st"> "NSW"</span>)</a>
<a class="sourceLine" id="cb9-23" title="23">  })</a>
<a class="sourceLine" id="cb9-24" title="24">})</a>
<a class="sourceLine" id="cb9-25" title="25"><span class="co">#&gt; Error: Test failed: 'variable values are correct'</span></a>
<a class="sourceLine" id="cb9-26" title="26"><span class="co">#&gt; * get_testdata() has invalid values in variable `pcode`. 1 cases have values other than `2000:2999, 3000:3999`.</span></a>
<a class="sourceLine" id="cb9-27" title="27"></a>
<a class="sourceLine" id="cb9-28" title="28">x &lt;-<span class="st"> </span>x <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">market =</span> <span class="kw">case_when</span>(pcode <span class="op">%in%</span><span class="st"> </span><span class="dv">2000</span><span class="op">:</span><span class="dv">2999</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb9-29" title="29">                                     pcode <span class="op">%in%</span><span class="st"> </span><span class="dv">3000</span><span class="op">:</span><span class="dv">3999</span> <span class="op">~</span><span class="st"> </span><span class="dv">2</span>))</a>
<a class="sourceLine" id="cb9-30" title="30"></a>
<a class="sourceLine" id="cb9-31" title="31"><span class="kw"><a href="../reference/global-data.html">with_testdata</a></span>(x, {</a>
<a class="sourceLine" id="cb9-32" title="32">  <span class="kw">test_that</span>(<span class="st">"market derived correctly"</span>, {</a>
<a class="sourceLine" id="cb9-33" title="33">    <span class="kw"><a href="../reference/value-expectations.html">expect_values</a></span>(market, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dt">miss =</span> <span class="ot">NULL</span>) <span class="co"># miss = NULL excludes NAs from valid values</span></a>
<a class="sourceLine" id="cb9-34" title="34">  })</a>
<a class="sourceLine" id="cb9-35" title="35">})</a>
<a class="sourceLine" id="cb9-36" title="36"><span class="co">#&gt; Error: Test failed: 'market derived correctly'</span></a>
<a class="sourceLine" id="cb9-37" title="37"><span class="co">#&gt; * get_testdata() has invalid values in variable `market`. 1 cases have values other than `1:2`.</span></a></code></pre></div>
<p>Note that:</p>
<ul>
<li><p>The global dataset must be reset after changes are made, either with <code><a href="../reference/global-data.html">set_testdata()</a></code> or <code><a href="../reference/global-data.html">with_testdata()</a></code>.</p></li>
<li><p>The <code>test_that()</code> wrapper is not strictly necessary, but it provides more informative error messaging and logically groups a set of expectations.</p></li>
<li><p>Each <code><a href="../reference/global-data.html">with_testdata()</a></code> block will fail on the first <code>test_that()</code> block that fails. The “filters applied correctly” test block is not run in the example.</p></li>
</ul>
</div>
</div>
<div id="using-a-test-suite" class="section level2">
<h2 class="hasAnchor">
<a href="#using-a-test-suite" class="anchor"></a>Using a test suite</h2>
<p>Setting up a proper project test suite can be useful for automatically validating final outputs before delivery.</p>
<p>Setting up proper file based testing infrastructure is out of the scope of this vignette. See <a href="http://r-pkgs.had.co.nz/tests.html">R packages</a> for a brief introduction to testing infrastructure.</p>
<p>Each set of tests in testthat has a <code>context()</code>. In testdat, each context has an associated dataset, specified with a call to <code><a href="../reference/global-data.html">context_data()</a></code>.</p>
<p><code><a href="../reference/global-data.html">context_data()</a></code> sets the value of the global test data as outlined above.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">context</span>(<span class="st">"Example"</span>)</a>
<a class="sourceLine" id="cb10-2" title="2"><span class="kw"><a href="../reference/global-data.html">context_data</a></span>(iris)</a>
<a class="sourceLine" id="cb10-3" title="3"></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="kw">test_that</span>(<span class="st">"Variable format checks"</span>, {</a>
<a class="sourceLine" id="cb10-5" title="5">  <span class="kw"><a href="../reference/value-expectations.html">expect_regex</a></span>(Species, <span class="st">"^[a-z]+$"</span>)</a>
<a class="sourceLine" id="cb10-6" title="6">})</a>
<a class="sourceLine" id="cb10-7" title="7"></a>
<a class="sourceLine" id="cb10-8" title="8"><span class="kw">test_that</span>(<span class="st">"Versicolor has sepal length greater than 5 - will fail"</span>, {</a>
<a class="sourceLine" id="cb10-9" title="9">  <span class="kw"><a href="../reference/conditional-expectations.html">expect_cond</a></span>(Species <span class="op">%in%</span><span class="st"> "versicolor"</span>, Sepal.Length <span class="op">&gt;=</span><span class="st"> </span><span class="dv">5</span>)</a>
<a class="sourceLine" id="cb10-10" title="10">})</a>
<a class="sourceLine" id="cb10-11" title="11"><span class="co">#&gt; Error: Test failed: 'Versicolor has sepal length greater than 5 - will fail'</span></a>
<a class="sourceLine" id="cb10-12" title="12"><span class="co">#&gt; * get_testdata() failed consistency check. 1 cases have `Species %in% "versicolor"` but not `Sepal.Length &gt;= 5`.</span></a></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#getting-started">Getting started</a></li>
      <li>
<a href="#data-expectations">Data expectations</a><ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li><a href="#categories">Categories</a></li>
      </ul>
</li>
      <li>
<a href="#using-tests">Using tests</a><ul class="nav nav-pills nav-stacked">
<li><a href="#testing-inside-a-script">Testing inside a script</a></li>
      <li><a href="#using-a-test-suite">Using a test suite</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Danny Smith.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
